<!DOCTYPE html>
<html>
<head>

    <title>Masih's PhD</title>


    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="http://rawgithub.com/jh3y/-cs-spinner/master/csspinner.css">
    <script src="https://www.google.com/jsapi"></script>
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="https://rawgithub.com/allmarkedup/purl/master/purl.js"></script>
    <script src="js/jquery.csv-0.71.min.js"></script>
    <script src="js/json2.js"></script>
    <script src="js/FileSaver.js"></script>
    <script src="js/chart.js"></script>
    <script src="js/jstat.js"></script>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 ">
            <div class="list-group small" id="chart_list" style="overflow: scroll; margin: 20px">
            </div>
        </div>

        <div class="col-md-9 main">
            <h1 class="page-header" id="main_title">Analysis</h1>

            <div id="chart2" style=" width: 100%; height: 500px;" class="ui-widget-content">
                <div class="csspinner traditional" id="spinner" style="float:left; display: none; height: 100%; width: 100%"></div>
                <div id="chart1" style=" width: 100%; height: 100%;" class="ui-widget-content"></div>
            </div>

            <div class="btn-group" style="margin:  5px 0;">
                <button type="button" class="btn btn-default" onclick='editor.openDialog(wrapper);' title="Edit"><span class="glyphicon glyphicon-cog"/> Edit</button>
                <button type="button" class="btn btn-default" onclick='saveChartOptions(wrapper, "chart_options.json");' title="Save Options"><span class="glyphicon glyphicon-download-alt"/> Options</button>
                <button type="button" class="btn btn-default" onclick='saveChartAsSVG("chart1", "chart.svg");' title="Save As SVG"><span class="glyphicon glyphicon-download-alt"/> SVG</button>
                <button type="button" class="btn btn-default" onclick='reset();' title="Reset"><span class="glyphicon glyphicon-refresh"/> Reset</button>
            </div>

            <div class="panel-group" id="filter_accordion">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#filter_accordion" href="#filter">
                                Filters
                            </a>
                        </h4>
                    </div>
                    <div id="filter" class="panel-collapse collapse in">
                        <div class="panel-body">
                            <ul class="nav nav-tabs" id="myTab">
                                <li class="active"><a href="#churn" data-toggle="tab">Churn</a></li>
                                <li><a href="#workload" data-toggle="tab">Workload</a></li>
                                <li><a href="#maintenance" data-toggle="tab">Maintenance</a></li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane active" id="churn">
                                    <div class="checkbox" id="churn_filters"></div>
                                </div>
                                <div class="tab-pane" id="workload">
                                    <div class="checkbox" id="workload_filters"></div>
                                </div>
                                <div class="tab-pane" id="maintenance">
                                    <div class="checkbox" id="maintenance_filters"></div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-default" onclick='filter()'>Filter</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel-group" id="matches_accordion">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#matches_accordion" href="#matches">
                                Matches
                            </a>
                        </h4>
                    </div>
                    <div id="matches" class="panel-collapse collapse">
                        <div class="panel-body">
                            <ul class="nav nav-tabs" id="matches_nav"></ul>
                            <div class="tab-content" id="matches_content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="js/bootstrap.min.js"></script>
<script>
    var chart_options;
    var query = decodeQuery(location.hash.slice(1)); //{metric: 0, churn: [], workload: [], maintenance: []};
    var default_observation = readAsJSON("config/chart_options.json");
    var wrapper = new google.visualization.ChartWrapper();
    wrapper.setContainerId('chart1');


    var editor = new google.visualization.ChartEditor();
    google.visualization.events.addListener(editor, 'ok',
            function () {
                wrapper = editor.getChartWrapper();
                wrapper.draw();
            });

    var data = {scenarios: readScenarios(), tidied_scenarios: new Array()};
    data.scenarios.forEach(function (scenario) {
        data.tidied_scenarios.push(tidyScenario(scenario));
    });

    var data_by_churn = data.tidied_scenarios.groupBy("churn");
    var data_by_workload = data.tidied_scenarios.groupBy("workload");
    var data_by_maintenance = data.tidied_scenarios.groupBy("maintenance");
    var observations = readAsJSON('config/observations.json').observations.sortBy("title");

    observations.forEach(function (observation, index) {
        var link = $('<a href="javascript:void(0)" class="list-group-item" id="metric_' +
                index +
                '"></a>');
        link.append(observation.title);
        link.click(function () {
            query.metric = index;
            window.location.hash = encodeQuery();
            $("#chart_list .active").removeClass("active");
            $("#main_title").text(observation.title);
            $(this).addClass("active");
        });
        $('#chart_list').append(link);
    });


    $("#chart_list a:first").addClass("active");
    selected_chart = observations[0].file_name;
    $("#main_title").text(observations[0].title);

    populateFilterCheckboxes(Object.keys(data_by_churn), 'churn_filters', 'churn');
    populateFilterCheckboxes(Object.keys(data_by_workload), 'workload_filters', 'workload');
    populateFilterCheckboxes(Object.keys(data_by_maintenance), 'maintenance_filters', 'maintenance');

    function filter() {

        var filtered = new Array();

        query.churn.forEach(function (selection) {
            data_by_churn[document.getElementById('churn_' + selection).value].forEach(function (element) {
                filtered.push(element);
            });
        })
        var ind = new Array();


        filtered = filtered.filter(function (element) {
            var found = false;
            query.workload.forEach(function (selection) {
                found = found || element.workload == document.getElementById('workload_' + selection).value;
            });
            return found;
        })
        filtered = filtered.filter(function (element) {
            var found = false;
            query.maintenance.forEach(function (selection) {
                found = found || element.maintenance == document.getElementById('maintenance_' + selection).value;
            });
            return found;
        })

        if (filtered.length == 0) {
            return;
        }

        var observation = $.extend(true, {}, default_observation, observations[query.metric])

        google.setOnLoadCallback(drawChart(wrapper, filtered, [2, 3], observation));
        var chart = wrapper.getChart();

        google.visualization.events.addListener(chart, 'select', function () {
            var selection = chart.getSelection();
            if (selection.length > 0 && selection[0].row == null) {
                var label = wrapper.getDataTable().getColumnLabel(selection[0].column);
                $('#matches').collapse('show');
                $('#match_link_' + label).tab('show');
            }
        });


        var matches_nav = $('#matches_nav');
        var matches_content = $('#matches_content');
        matches_nav.empty();
        matches_content.empty();

        filtered.forEach(function (match, index) {

            matches_nav.append('<li><a href="#' +
                    match.name +
                    '" data-toggle="tab"' +
                    ' id="match_link_' +
                    match.name +
                    '" class="small" >' +
                    '<span class="glyphicon glyphicon-stop" style="color: ' +
                    legend_colours[index] +
                    '"/> ' +
                    match.name +
                    "</a></li>");

            var div = $('<div class="tab-pane" id="' + match.name + '"></div>');
            var table = $('<table class="table small"></table>');
            Object.keys(match).forEach(function (key) {
                table.append('<tr>' +
                        '<td style="width: 15%"><strong>' +
                        key +
                        '</strong></td>' +
                        '<td>' +
                        match[key] +
                        '</td>' +
                        '</tr>')

            })
            div.append(table);
            matches_content.append(div);
        })

        $('#matches_nav a:first').tab('show');
        $('#filter').collapse('hide');
        $('#matches').collapse('show');
    }

    function reset() {
        filter();
    }


    function resizeElementHeight(element) {
        var height = 0;
        var body = window.document.body;
        if (window.innerHeight) {
            height = window.innerHeight;
        } else if (body.parentElement.clientHeight) {
            height = body.parentElement.clientHeight;
        } else if (body && body.clientHeight) {
            height = body.clientHeight;
        }
        element.style.height = ((height - element.offsetTop - 50) + "px");
    }

    resizeElementHeight(document.getElementById("chart_list"));
    $(function () {
        $("#chart2").resizable();
        $(window).bind('resize', function (e) {
            window.resizeEvt;
            $(window).resize(function () {
                clearTimeout(window.resizeEvt);
                window.resizeEvt = setTimeout(function () {
                    filter();
                    resizeElementHeight(document.getElementById("chart_list"));
                }, 250);
            });
        });
    });

    $(window).on('hashchange', function () {
        filter();

    });

    query.churn.forEach(function (selection) {
        $("#churn_" + selection).prop('checked', true);
    })
    query.workload.forEach(function (selection) {
        $("#workload_" + selection).prop('checked', true);
    })
    query.maintenance.forEach(function (selection) {
        $("#maintenance_" + selection).prop('checked', true);
    })

    $('#metric_' + query.metric).click()
    filter();

</script>
</body>
</html>
